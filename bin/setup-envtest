#!/bin/bash
set -e

SETUP_ENVTEST_VERSION=$(go list -m -f "{{ .Version }}" sigs.k8s.io/controller-runtime | awk -F'[v.]' '{printf "release-%d.%d", $2, $3}')

BIN_DIR="${PWD}/tmp"
BIN_NAME=setup-envtest
BIN_PATH="${BIN_DIR}/${BIN_NAME}"

if [ ! -f "${BIN_PATH}" ]
then
  # We cannot echo any message here, because that would break the expected output of setup-envtest which should be
  # the path where the assets were installed.
  mkdir -p "${BIN_DIR}"
  GOBIN="${BIN_DIR}" go install sigs.k8s.io/controller-runtime/tools/setup-envtest@${SETUP_ENVTEST_VERSION}
fi

exec "${BIN_PATH}" "$@"
